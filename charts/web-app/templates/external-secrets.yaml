{{- if and (.Values.enabled) (not .Values.local) }}
{{- if .Values.external_secrets.enabled }}

{{- if or (.Values.google.iap.enabled) (.Values.google.iap.test.enabled) }}

apiVersion: external-secrets.io/v1alpha1
kind: ExternalSecret
metadata:
  name: oauth-credentials
  namespace: {{ .Release.Namespace }}
  labels:
    backstage.io/kubernetes-id: {{ .Values.app_code }}
spec:
  {{- if .Values.external_secrets.refresh_interval }}
  refreshInterval: {{ .Values.external_secrets.refresh_interval }}
  {{- end }}
  secretStoreRef:
    kind: SecretStore
    name: secret-store
  target:
    name: oauth-credentials
    creationPolicy: Owner
  data:
  - secretKey: client_id
    remoteRef:
      key: oauth-id
  - secretKey: client_secret
    remoteRef:
      key: oauth-secret

---

{{- end }}


apiVersion: external-secrets.io/v1alpha1
kind: ExternalSecret
metadata:
  name: app-secrets
  namespace: {{ .Release.Namespace }}
spec:
  {{- if .Values.external_secrets.refresh_interval }}
  refreshInterval: {{ .Values.external_secrets.refresh_interval }}
  {{- end }}
  secretStoreRef:
    kind: SecretStore
    name: secret-store
  target:
    name: app-secrets
    creationPolicy: Owner
  data:
    {{- if .Values.django.enabled }}
    - secretKey: django-key
      remoteRef:
        key: django-key

    {{- if .Values.django.use_email }}
    - secretKey: email-password
      remoteRef:
        key: email-password
    {{- end }}

    {{- if .Values.django.oauth_id }}
    - secretKey: oauth-secret
      remoteRef:
        key: oauth-secret
    {{- end }}

    {{- end }}

    {{- if .Values.oauth.google.enabled }}
    - secretKey: google-oauth-id
      remoteRef:
        key: google-oauth-id

    - secretKey: google-oauth-secret
      remoteRef:
        key: google-oauth-secret

    {{- end }}

    {{- if .Values.oauth.google.sheets.enabled }}
    - secretKey: google-oauth-creds
      remoteRef:
        key: google-oauth-creds
    {{- end }}

    {{- if .Values.oauth.github.enabled }}
    - secretKey: github-oauth-id
      remoteRef:
        key: github-oauth-id

    - secretKey: github-oauth-secret
      remoteRef:
        key: github-oauth-secret
    {{- end }}

    {{- if .Values.oauth.facebook.enabled }}
    - secretKey: facebook-oauth-id
      remoteRef:
        key: facebook-oauth-id

    - secretKey: facebook-oauth-secret
      remoteRef:
        key: facebook-oauth-secret
    {{- end }}

    {{- if .Values.oauth.twitter.enabled }}
    - secretKey: twitter-api-key
      remoteRef:
        key: twitter-api-key

    - secretKey: twitter-api-key-secret
      remoteRef:
        key: twitter-api-key-secret
    {{- end }}

    {{- if .Values.firebase.enabled }}
    - secretKey: firebase-key
      remoteRef:
        key: firebase-key
    {{- end }}

    {{- if .Values.sendgrid.enabled }}
    - secretKey: sendgrid-key
      remoteRef:
        key: sendgrid-key
    {{- end }}

    {{- if .Values.twilio.enabled }}
    - secretKey: twilio-auth-token
      remoteRef:
        key: twilio-auth-token

    - secretKey: twilio-account-sid
      remoteRef:
        key: twilio-account-sid

    {{- if .Values.twilio.flex.enabled }}
    - secretKey: twilio-flex-workspace-id
      remoteRef:
        key: twilio-flex-workspace-id

    - secretKey: twilio-flex-workflow-sid
      remoteRef:
        key: twilio-flex-workflow-sid
    {{- end }}

    {{- end }}

    {{- if .Values.agile.enabled }}
    - secretKey: agile-crm-rest-key
      remoteRef:
        key: agile-crm-rest-key
    {{- end }}

    {{- if eq .Values.app_code "boatload" }}
    - secretKey: api-key
      remoteRef:
        key: api-key
    {{- end }}

{{- end }}
{{- end }}


